<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>State-diff Test (Webhook)</title>
<style>
  body{font-family:system-ui,Segoe UI,Roboto,Arial;background:#f6f9fc;padding:24px;color:#111}
  .card{max-width:820px;margin:0 auto;background:#fff;border-radius:10px;padding:18px;box-shadow:0 10px 30px rgba(15,30,60,.06)}
  h1{margin:0 0 8px;font-size:20px}
  label{display:block;margin:10px 0 6px;font-weight:600}
  input,button,select{width:100%;padding:10px;border:1px solid #d7dbe0;border-radius:6px;font-size:14px}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  #status{margin-top:12px;font-weight:700}
  pre{background:#f3f6fa;padding:10px;border-radius:6px;overflow:auto;white-space:pre-wrap}
  .modes{display:flex;gap:8px;margin:10px 0}
  .modes button{width:auto;padding:8px 12px}
  small{color:#666}
</style>
</head>
<body>
<div class="card">
  <h1>State-diff Test Page (GitHub Pages + Webhook)</h1>
  <p><small>Replace <code>WEBHOOK_URL</code> variable in the script with your webhook endpoint (webhook.site / Pipedream / RequestBin).</small></p>

  <div class="modes">
    <button id="modeFail">UI shows FAIL</button>
    <button id="modeSuccess">UI shows SUCCESS</button>
    <button id="modeDefault">Default</button>
  </div>
  <p>Current mode: <strong id="modeLabel"></strong></p>

  <form id="theForm">
    <label>Full name
      <input id="name" name="name" placeholder="Your full name" required>
    </label>

    <label>Email
      <input id="email" name="email" type="email" placeholder="you@example.com" required>
    </label>

    <div class="row">
      <div>
        <label>Bank account number
          <input id="bank" name="bank" placeholder="1234 5678 9012">
        </label>
      </div>
      <div>
        <label>Phone number
          <input id="phone" name="phone" placeholder="+61 4xx xxx xxx">
        </label>
      </div>
    </div>

    <label>Optional note
      <input id="note" name="note" placeholder="Optional note">
    </label>

    <button id="submitBtn" type="submit">Submit</button>
  </form>

  <p id="status">Waiting for submission…</p>

  <h4>Network / Debug log</h4>
  <pre id="log" style="height:240px"></pre>

  <p style="margin-top:12px;color:#666;font-size:13px">
    <!-- Use a webhook endpoint (webhook.site or Pipedream). After submit, check the webhook dashboard for incoming POSTs. If you see nothing there—follow the troubleshooting steps below. -->
  </p>
</div>

<script>
/* ================= CONFIG =================
   Replace this URL with your webhook endpoint (webhook.site / Pipedream)
   Example: "https://webhook.site/xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx"
*/
let WEBHOOK_URL = "https://webhook.site/#!/view/e88d3c00-661e-4199-a252-70bfe723ecea"; // <- REPLACE THIS
/* ========================================== */

const logEl = document.getElementById('log');
const statusEl = document.getElementById('status');
const modeLabel = document.getElementById('modeLabel');

let MODE = "uiShowsFail_but_backendGets"; // default on load
const setMode = (m) => { MODE = m; modeLabel.innerText = m; appendLog("Mode set -> " + m); };

document.getElementById('modeFail').onclick = ()=> setMode("uiShowsFail_but_backendGets");
document.getElementById('modeSuccess').onclick = ()=> setMode("uiShowsSuccess_but_backendFails");
document.getElementById('modeDefault').onclick = ()=> setMode("default");

setMode(MODE);

function appendLog(str){
  const t = new Date().toISOString() + "  " + str + "\n" + logEl.innerText;
  logEl.innerText = t;
}

/* Helpful small test to ensure WEBHOOK_URL changed */
appendLog("Configured WEBHOOK_URL: " + WEBHOOK_URL);

document.getElementById('theForm').onsubmit = async (e) => {
  e.preventDefault();
  const payload = {
    name: document.getElementById('name').value || "",
    email: document.getElementById('email').value || "",
    bank_account: document.getElementById('bank').value || "",
    phone: document.getElementById('phone').value || "",
    note: document.getElementById('note').value || "",
    ts: new Date().toISOString(),
    mode: MODE
  };

  appendLog("Form submit -> payload prepared");

  if (MODE === "uiShowsFail_but_backendGets") {
    // UI shows failure immediately, but still POST to webhook
    statusEl.innerText = "❌ Submission failed (UI simulated).";
    appendLog("UI: simulated failure shown to user");
    try {
      const r = await fetch(WEBHOOK_URL, {
        method: "POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify(payload),
        credentials: "omit"
      });
      const text = await r.text().catch(()=>"<no-body>");
      appendLog("Fetch done -> status: " + r.status + ", body: " + text);
    } catch (err) {
      appendLog("Fetch ERROR -> " + err);
    }
    return;
  }

  if (MODE === "uiShowsSuccess_but_backendFails") {
    // UI shows success, but webhook may be configured to return 500 (simulate backend fail)
    statusEl.innerText = "✅ Saved successfully (UI simulated).";
    appendLog("UI: simulated success shown to user");
    try {
      const r = await fetch(WEBHOOK_URL, {
        method: "POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify(payload),
        credentials: "omit"
      });
      const text = await r.text().catch(()=>"<no-body>");
      appendLog("Fetch done -> status: " + r.status + ", body: " + text);
      // show backend status for debugging (not for agent decision)
      appendLog("(Debug) backend returned status " + r.status);
    } catch (err) {
      appendLog("Fetch ERROR -> " + err);
    }
    return;
  }

  // default: synchronous UI <-> backend
  statusEl.innerText = "Submitting…";
  try {
    const r = await fetch(WEBHOOK_URL, {
      method: "POST",
      headers: {"Content-Type":"application/json"},
      body: JSON.stringify(payload),
      credentials: "omit"
    });
    const text = await r.text().catch(()=>"<no-body>");
    appendLog("Fetch done -> status: " + r.status + ", body: " + text);
    statusEl.innerText = r.ok ? "✅ Submitted & confirmed by backend" : "❌ Submitted but backend responded with non-OK";
  } catch (err) {
    appendLog("Fetch ERROR -> " + err);
    statusEl.innerText = "❌ Network / fetch error (see logs)";
  }
};
</script>
</body>
</html>
